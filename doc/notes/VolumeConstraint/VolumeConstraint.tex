\documentclass[12pt,aps,pre]{revtex4}
%\documentclass[aps,pre,onecolumn,superscriptaddress]{revtex4-1}
\usepackage{graphicx, epsfig,cancel}
\usepackage{color}
\usepackage{textcomp}
\usepackage{amssymb,amsmath} 
\usepackage{setspace}

% for writing code snippets in latex
\usepackage{listings}

\definecolor{dkgreen}{rgb}{0,0.6,0}
\definecolor{gray}{rgb}{0.5,0.5,0.5}
\definecolor{mauve}{rgb}{0.58,0,0.82}

\lstset{frame=tb,
  language=C++,
  aboveskip=3mm,
  belowskip=3mm,
  showstringspaces=false,
  columns=flexible,
  basicstyle={\small\ttfamily},
  numbers=none,
  numberstyle=\tiny\color{gray},
  keywordstyle=\color{blue},
  commentstyle=\color{dkgreen},
  stringstyle=\color{mauve},
  breaklines=true,
  breakatwhitespace=true,
  tabsize=3
}

\newcommand{\blue}[1]{\textcolor{blue}{#1}}
\newcommand{\red}[1]{\textcolor{red}{[#1]}}
\newcommand{\green}[1]{\textcolor{green}{#1}}


\begin{document}
\setstretch{1.5}
\title{Volume Constraint (Global Incompressibility)}
\author{V. W. L. Chan}
\maketitle

\section{Governing Equation}

Based on the work of Barocas group \cite{Chandran:2007hy,Stylianopoulos:2007dp} the macroscale momentum conservation equation is
%
\begin{eqnarray}
\sigma^{macro}_{ij,i} &=& Q_j \nonumber\\
%
&=&\frac{1}{V} \oint_{\partial V} \left( \sigma^{micro}_{ij} - \sigma^{macro}_{ij} \right)u_{k,i}n_k dS,
\label{eq:governing_eq}
\end{eqnarray}
%
where $u$ is the displacement of the RVE boundary and $n_k$ is the corresponding unit normal vector. The $Q$ term on the right of Eq.\ \eqref{eq:governing_eq} arises from using a material averaging volume at the microscale to calculate macroscale quantities \cite{Chandran:2007hy}:
%
\begin{equation}
\sigma_{ij}^{macro} = \frac{1}{V}\int_{V}\sigma_{ij}^{micro} dV,
\end{equation}
%
where $V$ is the material volume of the RVE.

The virtual work from Eq.\ \eqref{eq:governing_eq} is \cite{JavierBonet:2008uxa}
%
\begin{equation}
\delta W = \int_V \pmb{\sigma}^{macro} : \delta\pmb{d} dV - \int_{\partial V} \pmb{t} \cdot \delta \pmb{v} da + \int_V \pmb{Q} \cdot \delta \pmb{v} dV = 0,
\label{eq:weak_form}
\end{equation}
%
where $\delta \pmb{d}$ is the virtual rate of deformation tensor and $\delta \pmb{v}$ is the virtual velocity.

\section{Finite-Element Discretization}

The virtual work equation in Eq.\ \eqref{eq:weak_form} can be discretized by interpolating nodal virtual velocity $\delta \pmb{v}_a$ and nodal virtual displacement deformation rates $\delta \pmb{d}_a$ with shape functions $N_a$ \cite{JavierBonet:2008uxa}:
%
\begin{equation}
\delta \pmb{v} = \sum_{a=1}^n N_a \delta \pmb{v}_a \ \ \text{ and } \ \ \delta \pmb{d} = \frac{1}{2}\sum_{a=1}^n \left(\delta \pmb{v}_a \otimes \nabla N_a + \nabla N_a \otimes \delta \pmb{v}_a\right),
\label{eq:interpolation}
\end{equation}
%
respectively. Applying the interpolations in Eq.\ \eqref{eq:interpolation}, the contribution to the virtual work from a single nodal velocity $\delta \pmb{v}_a$ at a node a of element $(e)$ is 
%
\begin{eqnarray}
\delta W^{(e)}(\phi, N_a \delta \pmb{v}_a) &=& \delta \pmb{v}_a \cdot \left( \int_{V^{(e)}}\pmb{\sigma}^{macro} \nabla N_a dV - \int_{\partial V^{(e)}} N_a \pmb{t} da + \int_{V^{(e)}} N_a \pmb{Q}dV \right) \nonumber\\
%
&\equiv& \delta \pmb{v}_a \cdot \left(\pmb{T}^{(e)}_a - \pmb{F}^{(e)}_a\right),
\end{eqnarray}
%
$\phi$ denotes the current configuration. The contribution from all elements $e$ containing node $a (e \ni a)$ is 
%
\begin{equation}
\delta W(\phi, N_a \delta \pmb{v}_a) = \sum_{e=1, e\ni a}^{m_a} \delta W^{(e)}(\phi, N_a \delta \pmb{v}_a) = \delta \pmb{v}_a \cdot \left(\pmb{T}_a - \pmb{F}_a\right),
\end{equation}
%
where $m_a$ is the number of elements that contain node $a$. Finally, the contribution to $\delta W(\phi,\delta \pmb{v})$ from all nodes $N$ in the finite element mesh is
%
\begin{equation}
\delta W(\phi,\delta \pmb{v}) = \sum_{a=1}^N \delta W(\phi,N_a\delta\pmb{v}_a)=\sum_{a=1}^N \delta \pmb{v}_a \cdot \left(\pmb{T}_a - \pmb{F}_a\right) = 0.
\label{eq:weak_form_discretized}
\end{equation}
%

Since Eq.\ \eqref{eq:weak_form_discretized} must be satisfied for any arbitrary $\delta \pmb{v}_a$, the nodal residual force can be expressed as
%
\begin{equation}
\pmb{R}_a = \pmb{T}_a - \pmb{F}_a = 0,
\end{equation}
%
where the nodal residual force is zero when the internal nodal forces are in equilibrium with the external nodal forces at each node. The discretization in Eq.\ \eqref{eq:weak_form_discretized} can also be expressed in matrix form as
%
\begin{eqnarray}
&&\delta W(\phi,\delta\pmb{v}) = \delta \textbf{v}^T \textbf{R} = \delta \textbf{v}^T (\textbf{T} - \textbf{F})=0, \ \ \text{ where } \nonumber\\
%
&& \textbf{R} = \begin{bmatrix}
\pmb{R}_1 \\ \vdots \\ \pmb{R}_N
\end{bmatrix}, \ \
%
\textbf{T} = \begin{bmatrix}
\pmb{T}_1 \\ \vdots \\ \pmb{T}_N
\end{bmatrix}, \ \
%
\textbf{F} = \begin{bmatrix}
\pmb{F}_1 \\ \vdots \\ \pmb{F}_N
\end{bmatrix}, \ \
%
\delta\textbf{v} = \begin{bmatrix}
\delta\pmb{v}_1 \\ \vdots \\ \delta\pmb{v}_N
\end{bmatrix}.
\end{eqnarray}
%

\section{Volume Preservation Constraint Via Lagrangian Multiplier Method}

Following the procedure of Hirota et al.\ \cite{Hirota:2000jw} volume preservation can be posed as a constrained minimization problem of the virtual work
%
\begin{equation}
\begin{aligned}
\underset{ \pmb{u}}{\text{min}} \ \delta W \ \ \text{s.t.} \ \ \Delta V = 0, \ \ \text{where} \ \ \Delta V = V - V_{init},\
\end{aligned}
\end{equation}
%
where $\pmb{u}$ is the displacement. The constrained minimization problem can be converted to a saddle point problem
%
\begin{equation}
\begin{aligned}
\underset{\lambda}{\text{max}} \ \underset{\pmb{u}}{\text{min}} \ L,
\end{aligned}
\label{eq:saddlept}
\end{equation}
%
where $L$ is the Lagrangian
%
\begin{equation}
L \equiv \delta W + \lambda \Delta V
\label{eq:Lagrangian}
\end{equation}
%
and $\lambda$ is the Lagrangian multiplier. The solution to the saddle point problem satisfies two conditions
%
\begin{equation}
\begin{aligned}
&\frac{\partial L}{\partial \lambda} = \Delta V = 0 \\
&\frac{\partial L}{\partial \pmb{u}} = \frac{\partial \delta W}{\partial \pmb{u}} + \lambda \frac{\partial V}{\partial \pmb{u}} = 0,
\end{aligned}
\label{eq:conditions}
\end{equation}
%
where $\partial \Delta V/\partial \pmb{u} = \partial V/\partial \pmb{u}$. Note, the first condition explicitly preserves volume. 

To obtain a linear model, Eq.\ \eqref{eq:conditions} is linearized via a Taylor expansion \cite{Belytschko:2013tz}
%
\begin{equation}
\begin{aligned}
&\Delta V + \frac{\partial V}{\partial  \pmb{u}_a} \Delta \pmb{u}_a = 0 \\
%
&\pmb{R}_a + \lambda \frac{\partial V}{\partial \pmb{u}_a} + \left(\frac{\partial R_a}{\partial \pmb{u}_b} + \lambda \frac{\partial^2 V}{\partial \pmb{u}_a \partial \pmb{u}_b} \right) \Delta \pmb{u}_b + \frac{\partial V}{\partial \pmb{u}_a} \Delta \lambda =0,
\end{aligned}
\label{eq:taylor-expand}
\end{equation}
%
where the subscripts $a,b=1$ to $N$ indicate the nodes of the finite-element mesh and nodal residual force is $\pmb{R}_a = \partial \delta W/\partial  \pmb{u}_a$. Introducing the following matrices
%
\begin{eqnarray}
\textbf{G} \equiv \begin{bmatrix}
\frac{\partial V}{\partial \pmb{u}_1} \\ \vdots \\ \frac{\partial V}{\partial \pmb{u}_N} 
\end{bmatrix}, \ 
%
\textbf{u} \equiv \begin{bmatrix}
\pmb{u}_1 \\ \vdots \\ \pmb{u}_N
\end{bmatrix}, \ 
%
\textbf{H} \equiv \begin{bmatrix}
\frac{\partial^2 V}{\partial \pmb{u}_1\partial \pmb{u}_1} & \cdots & \frac{\partial^2 V}{\partial \pmb{u}_1\partial \pmb{u}_N}\\
%
\vdots & \ddots & \vdots \\
%
\frac{\partial^2 V}{\partial \pmb{u}_N\partial \pmb{u}_1} & \cdots & \frac{\partial^2 V}{\partial \pmb{u}_N\partial \pmb{u}_N}
\end{bmatrix} \text{ and }  
%
\textbf{K} \equiv \begin{bmatrix}
\frac{\partial \pmb{R}_1}{\partial \pmb{u}_1} & \cdots & \frac{\partial \pmb{R}_1}{\partial \pmb{u}_N} \\
%
\vdots & \ddots & \vdots \\
%
\frac{\partial \pmb{R}_N}{\partial \pmb{u}_1} & \cdots & \frac{\partial \pmb{R}_N}{\partial \pmb{u}_N} 
\end{bmatrix}
\label{eq:matrix_def}
\end{eqnarray}
%
the system of equations in Eq.\ \eqref{eq:taylor-expand} can be written in matrix form as
%
\begin{eqnarray}
\begin{bmatrix}
\textbf{K} + \lambda \textbf{H} & \textbf{G} \\
\textbf{G}^T & 0 
\end{bmatrix}
%
\begin{bmatrix}
\Delta \textbf{u} \\ \Delta \lambda
\end{bmatrix}
%
= \begin{bmatrix}
-\textbf{R}-\lambda \textbf{G} \\
- \Delta V 
\end{bmatrix}.
\label{eq:taylor-expand_matrix}
\end{eqnarray}
%
Note that the matrix \textbf{K} is the tangent-stiffness matrix and the system of equations in Eq.\ \eqref{eq:taylor-expand_matrix} represent one iteration step of a Newton-Raphson process. As discussed in Refs.\ \cite{Hirota:2000jw,Lai:2013fp}, the Lagrange multiplier $\lambda$ represents a hydrostatic pressure that acts to preserve the volume. The hydrostatic pressure and displacement of the equilibrium configuration is obtained by iterating Eq.\ \eqref{eq:taylor-expand_matrix}
%
\begin{eqnarray}
&&\begin{bmatrix}
\textbf{K} + \lambda \textbf{H} & \textbf{G} \\
\textbf{G}^T & 0 
\end{bmatrix}_k
%
\begin{bmatrix}
\Delta \textbf{u} \\ \Delta \lambda
\end{bmatrix}_{k+1}
%
= \begin{bmatrix}
-\textbf{R}-\lambda \textbf{G} \\
- \Delta V 
\end{bmatrix}_k \nonumber\\
%
&&\textbf{u}_{k+1} = \textbf{u}_k + \Delta \textbf{u} \nonumber\\
%
&&\lambda_{k+1} = \lambda_k + \Delta \lambda
\label{eq:taylor-expand_iterate}
\end{eqnarray}
%
until the appropriate norms of $\textbf{u}_{k+1} - \textbf{u}_k$ and $\lambda_{k+1} - \lambda_k$ are below some tolerance. The subscript $k$ in Eq.\ \eqref{eq:taylor-expand_iterate} denote the iteration step.

\section{Volume Preservation Constraint via Augmented Lagrangian Method}

To implement the augmented Lagrangian method, the Lagrangian in Eq.\ \eqref{eq:Lagrangian} is re-expressed as an augmented Lagrangian
%
\begin{equation}
AL = \delta W + \lambda \Delta V + \frac{1}{2}\beta(\Delta V)^2,
\label{eq:AugmentedLagrangian}
\end{equation}
%
where $\beta$ is a penalty parameter which improves upon the conditioning of the matrix of $L$. The solution to the saddle point problem of Eq.\ \eqref{eq:saddlept} now satisfies
%
\begin{equation}
\begin{aligned}
&\frac{\partial AL}{\partial \lambda} = \Delta V = 0 \\
&\frac{\partial AL}{\partial \pmb{u}} = \frac{\partial \delta W}{\partial \pmb{u}} + \lambda \frac{\partial V}{\partial \pmb{u}} + \beta \Delta V \frac{\partial V}{\partial \pmb{u}} = 0,
\end{aligned}
\label{eq:ALconditions}
\end{equation}
%
where as before the first condition explicitly preserves the volume.

To obtain a linear model, Eq.\ \eqref{eq:ALconditions} is linearized via a Taylor expansion
%
\begin{equation}
\begin{aligned}
&\Delta V + \frac{\partial V}{\partial  \pmb{u}_a} \Delta \pmb{u}_a = 0 \\
%
&\pmb{R}_a + \lambda \frac{\partial V}{\partial \pmb{u}_a} + \beta \Delta V \frac{\partial V}{\partial \pmb{u}_a}
%
+ \left(\frac{\partial R_a}{\partial \pmb{u}_b} + \lambda \frac{\partial^2 V}{\partial \pmb{u}_a \partial \pmb{u}_b} + \beta \frac{\partial V}{\partial \pmb{u}_b} \frac{\partial V}{\partial \pmb{u}_a} + \beta \Delta V \frac{\partial^2 V}{\partial \pmb{u}_a \partial \pmb{u}_b} \right) \Delta \pmb{u}_b 
%
+ \frac{\partial V}{\partial \pmb{u}_a} \Delta \lambda =0.
\end{aligned}
\label{eq:ALtaylor-expand}
\end{equation}
%
Using the matrices introduced in Eq.\ \eqref{eq:matrix_def}, Eq.\ \eqref{eq:ALtaylor-expand} can be expressed in matrix form as
%
\begin{eqnarray}
\begin{bmatrix}
\textbf{K} + \lambda \textbf{H} + \beta \left(\textbf{G} \textbf{G}^T + \Delta V \textbf{H} \right)& \textbf{G} \\
\textbf{G}^T & 0 
\end{bmatrix}
%
\begin{bmatrix}
\Delta \textbf{u} \\ \Delta \lambda
\end{bmatrix}
%
= \begin{bmatrix}
-\textbf{R}-\lambda \textbf{G} - \beta \Delta V \textbf{G} \\
- \Delta V 
\end{bmatrix}.
\label{eq:ALtaylor-expand_matrix}
\end{eqnarray}
%

\section{Iterative Implementation of Augmented Lagrangian Method}

Here Eqs.\ \eqref{eq:AugmentedLagrangian} and the second condition of \eqref{eq:ALconditions} are considered. This time a linear model is obtained only with respect to the displacement
%
\begin{equation}
\pmb{R}_a + \lambda \frac{\partial V}{\partial \pmb{u}_a} + \beta \Delta V \frac{\partial V}{\partial \pmb{u}_a}
%
+ \left(\frac{\partial R_a}{\partial \pmb{u}_b} + \lambda \frac{\partial^2 V}{\partial \pmb{u}_a \partial \pmb{u}_b} + \beta \frac{\partial V}{\partial \pmb{u}_b} \frac{\partial V}{\partial \pmb{u}_a} + \beta \Delta V \frac{\partial^2 V}{\partial \pmb{u}_a \partial \pmb{u}_b} \right) \Delta \pmb{u}_b  =0.
\label{eq:ALtaylor-expand_feedback}
\end{equation}
%
Once again using the matrices introduced in Eq.\ \eqref{eq:matrix_def}, Eq.\ \eqref{eq:ALtaylor-expand_feedback} can be expressed in matrix form as
%
\begin{eqnarray}
\begin{bmatrix}
\textbf{K} + \lambda \textbf{H} + \beta \left(\textbf{G} \textbf{G}^T + \Delta V \textbf{H} \right) 
\end{bmatrix}
%
\begin{bmatrix}
\Delta \textbf{u} \\
\end{bmatrix}
%
= \begin{bmatrix}
-\textbf{R}-\lambda \textbf{G} - \beta \Delta V \textbf{G}
\end{bmatrix},
\label{eq:ALtaylor-expand_matrix_feedback}
\end{eqnarray}
%
where $\lambda$ and $\beta$ are determined iteratively.

\section{Iterative Implementation of Lagrangian Method}

\subsection{Standard}
Here Eqs.\ \eqref{eq:Lagrangian} and the second condition of \eqref{eq:conditions} are considered. This time a linear model is obtained only with respect to the displacement
%
\begin{equation}
\pmb{R}_a + \lambda \frac{\partial V}{\partial \pmb{u}_a} 
%
+ \left(\frac{\partial R_a}{\partial \pmb{u}_b} + \lambda \frac{\partial^2 V}{\partial \pmb{u}_a \partial \pmb{u}_b}  \right) \Delta \pmb{u}_b  =0.
\label{eq:taylor-expand_feedback}
\end{equation}
%
Once again using the matrices introduced in Eq.\ \eqref{eq:matrix_def}, Eq.\ \eqref{eq:taylor-expand_feedback} can be expressed in matrix form as
%
\begin{eqnarray}
\begin{bmatrix}
\textbf{K} + \lambda \textbf{H} 
\end{bmatrix}
%
\begin{bmatrix}
\Delta \textbf{u} \\
\end{bmatrix}
%
= \begin{bmatrix}
-\textbf{R}-\lambda \textbf{G} 
\end{bmatrix},
\label{eq:taylor-expand_matrix_feedback}
\end{eqnarray}
%
where $\lambda$ is determined iteratively.

\subsection{$|\Delta V|^2$ }
%
\begin{equation}
L \equiv \delta W + \frac{1}{2}\lambda |\Delta V|^2
\label{eq:squared_Lagrangian}
\end{equation}
%
%
\begin{equation}
\pmb{R}_a + \lambda  |\Delta V| \frac{\partial V}{\partial \pmb{u}_a}
%
+ \left(\frac{\partial R_a}{\partial \pmb{u}_b} + \lambda \frac{\partial V}{\partial \pmb{u}_b} \frac{\partial V}{\partial \pmb{u}_a} + \lambda |\Delta V| \frac{\partial^2 V}{\partial \pmb{u}_a \partial \pmb{u}_b} \right) \Delta \pmb{u}_b  =0.
\label{eq:squared_taylor-expand_feedback}
\end{equation}
%

%
\begin{eqnarray}
\begin{bmatrix}
\textbf{K} + \lambda \left(\textbf{G} \textbf{G}^T + |\Delta V| \textbf{H} \right) 
\end{bmatrix}
%
\begin{bmatrix}
\Delta \textbf{u} \\
\end{bmatrix}
%
= \begin{bmatrix}
-\textbf{R}-\lambda|\Delta V| \textbf{G}
\end{bmatrix},
\label{eq:squared_taylor-expand_matrix_feedback}
\end{eqnarray}
%

\subsection{General Case}
%
\begin{equation}
L \equiv \delta W + \frac{1}{p}\lambda |\Delta V|^p
\label{eq:general_Lagrangian}
\end{equation}
%
%
\begin{equation}
\pmb{R}_a + \lambda  |\Delta V|^{p-1} \frac{\partial V}{\partial \pmb{u}_a}
%
+ \left(\frac{\partial R_a}{\partial \pmb{u}_b} + \lambda(p-1)|\Delta V|^{p-1} \frac{\partial V}{\partial \pmb{u}_b} \frac{\partial V}{\partial \pmb{u}_a} + \lambda |\Delta V|^{p-1} \frac{\partial^2 V}{\partial \pmb{u}_a \partial \pmb{u}_b} \right) \Delta \pmb{u}_b  =0.
\label{eq:general_taylor-expand_feedback}
\end{equation}
%

%
\begin{eqnarray}
\begin{bmatrix}
\textbf{K} + \lambda \left((p-1)|\Delta V|^{p-2}\textbf{G} \textbf{G}^T + |\Delta V|^{p-1} \textbf{H} \right) 
\end{bmatrix}
%
\begin{bmatrix}
\Delta \textbf{u} \\
\end{bmatrix}
%
= \begin{bmatrix}
-\textbf{R}-\lambda|\Delta V|^{p-1} \textbf{G}
\end{bmatrix},
\label{eq:general_taylor-expand_matrix_feedback}
\end{eqnarray}
%

\section{Volume Calculations (Element Wise)}

The volume (in physical space) of each tetrahedra element in the finite element mesh can be determined from the Gauss quadrature rule
%
\begin{equation}
V^{(e)} = \sum_{i=1}^{n_{gp}} W_i \text{det}(\pmb{J}^e(\xi_1,\xi_2,\xi_3)),
\end{equation}
%
where $W_i$ the Gauss quadrature weight, $n_{gp}$ is the number of Gauss points, and $\pmb{J}^e(\xi_1,\xi_2,\xi_3)$ is the Jacobian of a tetrahedra element (same as in apf)
%
\begin{equation}
\pmb{J}^e \equiv 
\begin{bmatrix}
\frac{\partial x}{\partial \xi_1} & \frac{\partial x}{\partial \xi_2} & \frac{\partial x}{\partial \xi_3} \\
\frac{\partial y}{\partial \xi_1} & \frac{\partial y}{\partial \xi_2} & \frac{\partial y}{\partial \xi_3} \\
\frac{\partial z}{\partial \xi_1} & \frac{\partial z}{\partial \xi_2} & \frac{\partial z}{\partial \xi_3} 
\end{bmatrix} = 
%
\sum_{i=1}^{n_{en}}
\begin{bmatrix}
\frac{\partial N_i}{\partial \xi_1} x_i^e & \frac{\partial N_i}{\partial \xi_2} x_i^e & \frac{\partial N_i}{\partial \xi_3} x_i^e \\
%
\frac{\partial N_i}{\partial \xi_1}y_i^e & \frac{\partial N_i}{\partial \xi_2}y_i^e & \frac{\partial N_i}{\partial \xi_3}y_i^e \\
%
\frac{\partial N_i}{\partial \xi_1}z_i^e & \frac{\partial N_i}{\partial \xi_2}z_i^e & \frac{\partial N_i}{\partial \xi_3}z_i^e 
\end{bmatrix},
\label{eq:jacobian}
\end{equation}
%
where $n_{en}$ is the number of element nodes and $x_i^e, y_i^e, z_i^e$ are the $x,y,z$ coordinates of the $i^{th}$ node of the tetrahedra element.

For a linear tetrahedra element, $n_{gp}=1$, $W_1=1/6$, and $n_{en}=4$. The shape functions and its derivatives are therefore
%
\begin{equation}
N_1 = 1- \xi_1 - \xi_2 - \xi_3, \ \ 
N_2 = \xi_1, \ \
N_3 = \xi_2, \ \text{ and } \
N_4 = \xi_3
\label{eq:tet_shape_fxns}
\end{equation}
%
and
%
\begin{eqnarray}
&&\frac{\partial N_1}{\partial \xi_1} = -1, \frac{\partial N_1}{\partial \xi_2} = -1, \frac{\partial N_1}{\partial \xi_3} = -1 \nonumber\\
%
&&\frac{\partial N_2}{\partial \xi_1} = 1, \frac{\partial N_2}{\partial \xi_2} = 0, \frac{\partial N_2}{\partial \xi_3} = 0 \nonumber\\
%
&&\frac{\partial N_3}{\partial \xi_1} = 0, \frac{\partial N_3}{\partial \xi_2} = 1, \frac{\partial N_3}{\partial \xi_3} = 0 \nonumber\\
%
&&\frac{\partial N_4}{\partial \xi_1} = 0, \frac{\partial N_4}{\partial \xi_2} = 0, \frac{\partial N_4}{\partial \xi_3} = 1,
\label{eq:tet_shape_fxns_deriv}
\end{eqnarray}
%
respectively. Combining Eqs.\ \eqref{eq:jacobian}, \eqref{eq:tet_shape_fxns}, and \eqref{eq:tet_shape_fxns_deriv}, the Jacobian and its determinant for a linear tetrahedra element is 
%
\begin{eqnarray}
\pmb{J}^e &=& \begin{bmatrix}
x_2^e - x_1^e & x_3^e - x_1^e & x_4^e - x_1^e \\
%
y_2^e - y_1^e & y_3^e - y_1^e & y_4^e - y_1^e \\
%
z_2^e - z_1^e & z_3^e - z_1^e & z_4^e - z_1^e 
\end{bmatrix} \nonumber\\
%
\text{det}(\pmb{J}^e) &=& (x_2^e - x_1^e)[(y_3^e - y_1^e)(z_4^e - z_1^e)-(y_4^e - y_1^e)(z_3^e - z_1^e)] \nonumber\\
%
&&-(x_3^e - x_1^e)[(y_2^e - y_1^e)(z_4^e - z_1^e)-(y_4^e - y_1^e)(z_2^e - z_1^e)] \nonumber\\
%
&&+(x_4^e - x_1^e)[(y_2^e - y_1^e)(z_3^e - z_1^e)-(y_3^e - y_1^e)(z_2^e - z_1^e)].
\end{eqnarray}
%
Therefore, the volume of each linear tetrahedra element can be calculated from the coordinates of its corner nodes.

The total volume is calculated by summing over the volume of each element
%
\begin{equation}
V = \sum_{e=1}^{N_{el}} V^{(e)} = \frac{1}{6}\sum_{e=1}^{N_{el}}\text{det}\left( \begin{bmatrix}
x_2^e - x_1^e & x_3^e - x_1^e & x_4^e - x_1^e \\
%
y_2^e - y_1^e & y_3^e - y_1^e & y_4^e - y_1^e \\
%
z_2^e - z_1^e & z_3^e - z_1^e & z_4^e - z_1^e 
\end{bmatrix}\right),
\label{eq:total_volume}
\end{equation}
%
where $N_{el}$ is the number of linear tetrahedra elements in the finite-element mesh. Both the current and initial volumes can be calculated by Eq.\ \eqref{eq:total_volume}.

\subsection{First Derivative of Total Volume}

The change of total volume from the change of a single nodal displacement $\pmb{u}_a$ at a node $a$ (=1 to 4 for linear tetrahedra element) of element $e$ is
%
\begin{eqnarray}
\frac{\partial V}{\partial \pmb{u}_a^e} &=& \frac{\partial V}{\partial (\pmb{x}_a^e-\pmb{X}_a^e)} = \frac{\partial V}{\partial \pmb{x}_a^e} \nonumber\\
%%
&=& \frac{\partial}{\partial \pmb{x}_a^e} \sum_{e=1}^{N_{el}}V^{(e)} = \sum_{e=1}^{N_{el}}\frac{\partial V^{(e)}}{\partial \pmb{x}_a^e}
%%
= W_1\begin{bmatrix}
\frac{\partial V}{\partial x_a^e} \\ \frac{\partial V}{\partial y_a^e} \\ \frac{\partial V}{\partial z_a^e}
\end{bmatrix},
\label{eq:dVdu}
\end{eqnarray}
%
where the derivative of the total volume has been rewritten as the sum of the derivatives of element volumes. To understand how to compute Eq.\ \eqref{eq:dVdu}, the x-component is written out explicitly
%
\begin{eqnarray}
\frac{\partial V}{\partial x_a^e} &=& W_1\sum_{e=1}^{N_{el}} \frac{\partial}{\partial x_a^e}\text{det}\left(\sum_{i=1}^{n_{en}}
\begin{bmatrix}
\frac{\partial N_i}{\partial \xi_1} x_i^e & \frac{\partial N_i}{\partial \xi_2} x_i^e & \frac{\partial N_i}{\partial \xi_3} x_i^e \\
%
\frac{\partial N_i}{\partial \xi_1}y_i^e & \frac{\partial N_i}{\partial \xi_2}y_i^e & \frac{\partial N_i}{\partial \xi_3}y_i^e \\
%
\frac{\partial N_i}{\partial \xi_1}z_i^e & \frac{\partial N_i}{\partial \xi_2}z_i^e & \frac{\partial N_i}{\partial \xi_3}z_i^e 
\end{bmatrix}\right) = W_1\sum_{e=1}^{N_{el}} \text{det}\left(\sum_{i=1}^{n_{en}}
%
\begin{bmatrix}
\frac{\partial N_a}{\partial \xi_1}  & \frac{\partial N_a}{\partial \xi_2} & \frac{\partial N_a}{\partial \xi_3} \\
%
\frac{\partial N_i}{\partial \xi_1}y_i^e  & \frac{\partial N_i}{\partial \xi_2}y_i^e & \frac{\partial N_i}{\partial \xi_3}y_i^e \\
%
\frac{\partial N_i}{\partial \xi_1}z_i^e  & \frac{\partial N_i}{\partial \xi_2}z_i^e & \frac{\partial N_i}{\partial \xi_3}z_i^e 
\end{bmatrix}\right) \nonumber\\
%%%
&=& W_1\sum_{e=1}^{N_{el}} \text{det}\left(
%
\begin{bmatrix}
\frac{\partial N_a}{\partial \xi_1}  & \frac{\partial N_a}{\partial \xi_2} & \frac{\partial N_a}{\partial \xi_3} \\
%
y_2^e - y_1^e & y_3^e - y_1^e & y_4^e - y_1^e \\
%
z_2^e - z_1^e & z_3^e - z_1^e & z_4^e - z_1^e 
\end{bmatrix}\right)\nonumber\\
&=& W_1\sum_{e=1}^{N_{el}}\frac{\partial N_a}{\partial \xi_1}[(y_3^e - y_1^e)(z_4^e - z_1^e)-(y_4^e - y_1^e)(z_3^e - z_1^e)] \nonumber\\
%
&&-\frac{\partial N_a}{\partial \xi_2}\left[(y_2^e - y_1^e)(z_4^e - z_1^e)-(y_4^e - y_1^e)(z_2^e - z_1^e)\right] \nonumber\\
%
&&+\frac{\partial N_a}{\partial \xi_3}\left[(y_2^e - y_1^e)(z_3^e - z_1^e)-(y_3^e - y_1^e)(z_2^e - z_1^e)\right].
\label{eq:dVdx}
\end{eqnarray}
%
Similarly, the $y$ and $z$ components are
%
\begin{eqnarray}
\frac{\partial V}{\partial y_a^e} &=& W_1\sum_{e=1}^{N_{el}} \text{det}\left(\sum_{i=1}^{n_{en}} \begin{bmatrix}
\frac{\partial N_i}{\partial \xi_1}x_i^e  & \frac{\partial N_i}{\partial \xi_2}x_i^e  & \frac{\partial N_i}{\partial \xi_3}x_i^e \\
%
\frac{\partial N_a}{\partial \xi_1} & \frac{\partial N_a}{\partial \xi_2} & \frac{\partial N_a}{\partial \xi_3} \\
%
\frac{\partial N_i}{\partial \xi_1}z_i^e  & \frac{\partial N_i}{\partial \xi_2}z_i^e & \frac{\partial N_i}{\partial \xi_3}z_i^e 
\end{bmatrix}\right) 
%%
=W_1 \sum_{e=1}^{N_{el}} \text{det}\left( \begin{bmatrix}
x_2^e - x_1^e & x_3^e - x_1^e & x_4^e - x_1^e \\
%
\frac{\partial N_a}{\partial \xi_1} & \frac{\partial N_a}{\partial \xi_2} & \frac{\partial N_a}{\partial \xi_3} \\
%
z_2^e - z_1^e & z_3^e - z_1^e & z_4^e - z_1^e 
\end{bmatrix}\right)
\nonumber\\
%
&=&W_1\sum_{e=1}^{N_{el}}(x_2^e - x_1^e)\left[\frac{\partial N_a}{\partial \xi_2}(z_4^e - z_1^e)-\frac{\partial N_a}{\partial \xi_3}(z_3^e - z_1^e)\right] \nonumber\\
%
&&-(x_3^e - x_1^e)\left[\frac{\partial N_a}{\partial \xi_1}(z_4^e - z_1^e)-\frac{\partial N_a}{\partial \xi_3}(z_2^e - z_1^e)\right] \nonumber\\
%
&&+(x_4^e - x_1^e)\left[\frac{\partial N_a}{\partial \xi_1}(z_3^e - z_1^e)-\frac{\partial N_a}{\partial \xi_2}(z_2^e - z_1^e)\right] \nonumber\\
%%%%
\frac{\partial V}{\partial z_a^e} &=& W_1\sum_{e=1}^{N_{el}} \text{det}\left(\sum_{i=1}^{n_{en}} \begin{bmatrix}
\frac{\partial N_i}{\partial \xi_1}x_i^e  & \frac{\partial N_i}{\partial \xi_2}x_i^e & \frac{\partial N_i}{\partial \xi_3}x_i^e \\
%
\frac{\partial N_i}{\partial \xi_1}y_i^e & \frac{\partial N_i}{\partial \xi_2}y_i^e & \frac{\partial N_i}{\partial \xi_3}y_i^e \\
%
\frac{\partial N_a}{\partial \xi_1}  & \frac{\partial N_a}{\partial \xi_2} & \frac{\partial N_a}{\partial \xi_3} 
\end{bmatrix}\right) 
%%
=W_1 \sum_{e=1}^{N_{el}} \text{det}\left( \begin{bmatrix}
x_2^e - x_1^e & x_3^e - x_1^e & x_4^e - x_1^e \\
%
y_2^e - y_1^e & y_3^e - y_1^e & y_4^e - y_1^e \\
%
\frac{\partial N_a}{\partial \xi_1}  & \frac{\partial N_a}{\partial \xi_2} & \frac{\partial N_a}{\partial \xi_3} 
\end{bmatrix}\right)  \nonumber\\
%
&=&W_1\sum_{e=1}^{N_{el}}(x_2^e - x_1^e)\left[(y_3^e - y_1^e)\frac{\partial N_a}{\partial \xi_3}-(y_4^e - y_1^e)\frac{\partial N_a}{\partial \xi_2}\right] \nonumber\\
%
&&-(x_3^e - x_1^e)\left[(y_2^e - y_1^e)\frac{\partial N_a}{\partial \xi_3}-(y_4^e - y_1^e)\frac{\partial N_a}{\partial \xi_1}\right] \nonumber\\
%
&&+(x_4^e - x_1^e)\left[(y_2^e - y_1^e)\frac{\partial N_a}{\partial \xi_2}-(y_3^e - y_1^e)\frac{\partial N_a}{\partial \xi_1}\right].
\label{eq:dVdy-dVdz}
\end{eqnarray}

\subsection{Second Derivative of Total Volume}

The second derivative of the total volume is determined by observing the change of Eq.\ \eqref{eq:dVdu} due to the change of a single nodal displacement $\pmb{u}_b$ at a node of $b$ (=1 to 4 for tetrahedra element) of element $e$
%
\begin{eqnarray}
\frac{\partial}{\partial \pmb{u}^e_b}\frac{\partial V}{\partial \pmb{u}_a^e} &=& \frac{\partial}{\partial \pmb{x}^e_b}\frac{\partial V}{\partial \pmb{x}_a^e} 
%
=\sum_{e=1}^{N_{el}}\frac{\partial^2 V^{(e)}}{\partial \pmb{x}_a^e \partial \pmb{x}_b^e} = 
%
W_1\begin{bmatrix}
\frac{\partial^2 V}{\partial x_a^e \partial x_b^e} & \frac{\partial^2 V}{\partial x_a^e \partial y_b^e} & \frac{\partial^2 V}{\partial x_a^e \partial z_b^e} \\
%
\frac{\partial^2 V}{\partial y_a^e \partial x_b^e} & \frac{\partial^2 V}{\partial y_a^e \partial y_b^e} & \frac{\partial^2 V}{\partial y_a^e \partial z_b^e} \\
%
\frac{\partial^2 V}{\partial z_a^e \partial x_b^e} & \frac{\partial^2 V}{\partial z_a^e \partial y_b^e} & \frac{\partial^2 V}{\partial z_a^e \partial z_b^e} 
\end{bmatrix},
\label{eq:dVduadub}
\end{eqnarray}
%
where as before the second derivative of the total volume has been written as the summation of the second derivative of element volumes. 

The diagonal terms of Eq.\ \eqref{eq:dVduadub} are
%
\begin{eqnarray}
\frac{\partial^2 V}{\partial x_a^e \partial x_b^e} &=& W_1\sum_{e=1}^{N_{el}} \text{det}\left(\sum_{i=1}^{n_{en}}
%
\begin{bmatrix}
\frac{\partial N_a}{\partial \xi_1}+\frac{\partial N_b}{\partial \xi_1}  & \frac{\partial N_a}{\partial \xi_2}+\frac{\partial N_b}{\partial \xi_2} & \frac{\partial N_a}{\partial \xi_3}+\frac{\partial N_b}{\partial \xi_3} \\
%
\frac{\partial N_i}{\partial \xi_1}y_i^e   & \frac{\partial N_i}{\partial \xi_2}y_i^e & \frac{\partial N_i}{\partial \xi_3}y_i^e \\
%
\frac{\partial N_i}{\partial \xi_1}z_i^e  & \frac{\partial N_i}{\partial \xi_2}z_i^e & \frac{\partial N_i}{\partial \xi_3}z_i^e 
\end{bmatrix}\right) \nonumber\\
%%%
&=&W_1 \sum_{e=1}^{N_{el}} \text{det}\left(
%
\begin{bmatrix}
\frac{\partial N_a}{\partial \xi_1}+\frac{\partial N_b}{\partial \xi_1}  & \frac{\partial N_a}{\partial \xi_2}+\frac{\partial N_b}{\partial \xi_2} & \frac{\partial N_a}{\partial \xi_3}+\frac{\partial N_b}{\partial \xi_3} \\
%
y_2^e - y_1^e & y_3^e - y_1^e & y_4^e - y_1^e \\
%
z_2^e - z_1^e & z_3^e - z_1^e & z_4^e - z_1^e 
\end{bmatrix}\right) \nonumber\\
%%%
&=& W_1\sum_{e=1}^{N_{el}}\left(\frac{\partial N_a}{\partial \xi_1}+\frac{\partial N_b}{\partial \xi_1}\right)[(y_3^e - y_1^e)(z_4^e - z_1^e)-(y_4^e - y_1^e)(z_3^e - z_1^e)] \nonumber\\
%
&&-\left(\frac{\partial N_a}{\partial \xi_2}+\frac{\partial N_b}{\partial \xi_2}\right)\left[(y_2^e - y_1^e)(z_4^e - z_1^e)-(y_4^e - y_1^e)(z_2^e - z_1^e)\right] \nonumber\\
%
&&+\left(\frac{\partial N_a}{\partial \xi_3}+\frac{\partial N_b}{\partial \xi_3}\right)\left[(y_2^e - y_1^e)(z_3^e - z_1^e)-(y_3^e - y_1^e)(z_2^e - z_1^e)\right]
\end{eqnarray}
%%%%%
%%%%%
%%%%%
\begin{eqnarray}
\frac{\partial^2 V}{\partial y_a^e \partial y_b^e} &=& W_1\sum_{e=1}^{N_{el}} \text{det}\left(\sum_{i=1}^{n_{en}} \begin{bmatrix}
\frac{\partial N_i}{\partial \xi_1}x_i^e  & \frac{\partial N_i}{\partial \xi_2}x_i^e  & \frac{\partial N_i}{\partial \xi_3}x_i^e  \\
%
\frac{\partial N_a}{\partial \xi_1}+\frac{\partial N_b}{\partial \xi_1} & \frac{\partial N_a}{\partial \xi_2}+\frac{\partial N_b}{\partial \xi_2}& \frac{\partial N_a}{\partial \xi_3}+\frac{\partial N_b}{\partial \xi_3} \\
%
\frac{\partial N_i}{\partial \xi_1}z_i^e & \frac{\partial N_i}{\partial \xi_2}z_i^e & \frac{\partial N_i}{\partial \xi_3}z_i^e 
\end{bmatrix}\right) \nonumber\\
%%%
&=& W_1\sum_{e=1}^{N_{el}} \text{det}\left( \begin{bmatrix}
x_2^e - x_1^e & x_3^e - x_1^e & x_4^e - x_1^e \\
%
\frac{\partial N_a}{\partial \xi_1}+\frac{\partial N_b}{\partial \xi_1} & \frac{\partial N_a}{\partial \xi_2}+\frac{\partial N_b}{\partial \xi_2}& \frac{\partial N_a}{\partial \xi_3}+\frac{\partial N_b}{\partial \xi_3} \\
%
z_2^e - z_1^e & z_3^e - z_1^e & z_4^e - z_1^e 
\end{bmatrix}\right) \nonumber\\
%
&=&W_1\sum_{e=1}^{N_{el}}(x_2^e - x_1^e)\left[\left(\frac{\partial N_a}{\partial \xi_2}+\frac{\partial N_b}{\partial \xi_2}\right)(z_4^e - z_1^e)-\left(\frac{\partial N_a}{\partial \xi_3}+\frac{\partial N_b}{\partial \xi_3}\right)(z_3^e - z_1^e)\right] \nonumber\\
%
&&-(x_3^e - x_1^e)\left[\left(\frac{\partial N_a}{\partial \xi_1}+\frac{\partial N_b}{\partial \xi_1}\right)(z_4^e - z_1^e)-\left(\frac{\partial N_a}{\partial \xi_3}+\frac{\partial N_b}{\partial \xi_3}\right)(z_2^e - z_1^e)\right] \nonumber\\
%
&&+(x_4^e - x_1^e)\left[\left(\frac{\partial N_a}{\partial \xi_1}+\frac{\partial N_b}{\partial \xi_1}\right)(z_3^e - z_1^e)-\left(\frac{\partial N_a}{\partial \xi_2}+\frac{\partial N_b}{\partial \xi_2}\right)(z_2^e - z_1^e)\right] 
\end{eqnarray}
%%%%%
%%%%%
%%%%%
\begin{eqnarray}
\frac{\partial^2 V}{\partial z_a^e \partial z_b^e} &=& W_1\sum_{e=1}^{N_{el}} \text{det}\left(\sum_{i=1}^{n_{en}} \begin{bmatrix}
\frac{\partial N_i}{\partial \xi_1}x_i^e  & \frac{\partial N_i}{\partial \xi_2}x_i^e  & \frac{\partial N_i}{\partial \xi_3}x_i^e \\
%
\frac{\partial N_i}{\partial \xi_1}y_i^e & \frac{\partial N_i}{\partial \xi_2}y_i^e & \frac{\partial N_i}{\partial \xi_3}y_i^e \\
%
\frac{\partial N_a}{\partial \xi_1}+\frac{\partial N_b}{\partial \xi_1}  & \frac{\partial N_a}{\partial \xi_2}+\frac{\partial N_b}{\partial \xi_2}  & \frac{\partial N_a}{\partial \xi_3}+\frac{\partial N_b}{\partial \xi_3} 
\end{bmatrix}\right) \nonumber\\
%%%
&=& W_1\sum_{e=1}^{N_{el}} \text{det}\left( \begin{bmatrix}
x_2^e - x_1^e & x_3^e - x_1^e & x_4^e - x_1^e \\
%
y_2^e - y_1^e & y_3^e - y_1^e & y_4^e - y_1^e \\
%
\frac{\partial N_a}{\partial \xi_1}+\frac{\partial N_b}{\partial \xi_1}  & \frac{\partial N_a}{\partial \xi_2}+\frac{\partial N_b}{\partial \xi_2}  & \frac{\partial N_a}{\partial \xi_3}+\frac{\partial N_b}{\partial \xi_3} 
\end{bmatrix}\right) \nonumber\\
%
&=&W_1\sum_{e=1}^{N_{el}}(x_2^e - x_1^e)\left[(y_3^e - y_1^e)\left(\frac{\partial N_a}{\partial \xi_3}+\frac{\partial N_b}{\partial \xi_3}\right)-(y_4^e - y_1^e)\left(\frac{\partial N_a}{\partial \xi_2}+\frac{\partial N_b}{\partial \xi_2}\right)\right] \nonumber\\
%
&&-(x_3^e - x_1^e)\left[(y_2^e - y_1^e)\left(\frac{\partial N_a}{\partial \xi_3}+\frac{\partial N_b}{\partial \xi_3}\right)-(y_4^e - y_1^e)\left(\frac{\partial N_a}{\partial \xi_1}+\frac{\partial N_b}{\partial \xi_1}\right)\right] \nonumber\\
%
&&+(x_4^e - x_1^e)\left[(y_2^e - y_1^e)\left(\frac{\partial N_a}{\partial \xi_2}+\frac{\partial N_b}{\partial \xi_2}\right)-(y_3^e - y_1^e)\left(\frac{\partial N_a}{\partial \xi_1}+\frac{\partial N_b}{\partial \xi_1}\right)\right].
\end{eqnarray}


The off-diagonal terms of Eq.\ \eqref{eq:dVduadub} are
%
\begin{eqnarray}
\frac{\partial^2 V}{\partial x_a^e \partial y_b^e} &=&W_1 \sum_{e=1}^{N_{el}} \text{det}\left(\sum_{i=1}^{n_{en}}
%
\begin{bmatrix}
\frac{\partial N_a}{\partial \xi_1}  & \frac{\partial N_a}{\partial \xi_2} & \frac{\partial N_a}{\partial \xi_3}  \\
%
\frac{\partial N_b}{\partial \xi_1}  & \frac{\partial N_b}{\partial \xi_2} & \frac{\partial N_b}{\partial \xi_3}  \\
%
\frac{\partial N_i}{\partial \xi_1}z_i^e  & \frac{\partial N_i}{\partial \xi_2}z_i^e & \frac{\partial N_i}{\partial \xi_3}z_i^e 
\end{bmatrix}\right) 
%
=W_1 \sum_{e=1}^{N_{el}} \text{det}\left(
%
\begin{bmatrix}
\frac{\partial N_a}{\partial \xi_1}  & \frac{\partial N_a}{\partial \xi_2} & \frac{\partial N_a}{\partial \xi_3}  \\
%
\frac{\partial N_b}{\partial \xi_1}  & \frac{\partial N_b}{\partial \xi_2} & \frac{\partial N_b}{\partial \xi_3}  \\
%
z_2^e - z_1^e & z_3^e - z_1^e & z_4^e - z_1^e 
\end{bmatrix}\right)\nonumber\\
%%%
&=& W_1\sum_{e=1}^{N_{el}}\frac{\partial N_a}{\partial \xi_1}\left[\frac{\partial N_b}{\partial \xi_2}(z_4^e - z_1^e)-\frac{\partial N_b}{\partial \xi_3}(z_3^e - z_1^e)\right]
%
-\frac{\partial N_a}{\partial \xi_2}\left[\frac{\partial N_b}{\partial \xi_1}(z_4^e - z_1^e)-\frac{\partial N_b}{\partial \xi_3}(z_2^e - z_1^e)\right] \nonumber\\
%
&&+\frac{\partial N_a}{\partial \xi_3}\left[\frac{\partial N_b}{\partial \xi_1}(z_3^e - z_1^e)-\frac{\partial N_b}{\partial \xi_2}(z_2^e - z_1^e)\right] 
\end{eqnarray}
%%%%%
%%%%%
%%%%%
\begin{eqnarray}
\frac{\partial^2 V}{\partial x_a^e \partial z_b^e} &=&  W_1\sum_{e=1}^{N_{el}} \text{det}\left(\sum_{i=1}^{n_{en}}
%
\begin{bmatrix}
\frac{\partial N_a}{\partial \xi_1}  &  \frac{\partial N_a}{\partial \xi_2} &  \frac{\partial N_a}{\partial \xi_3}\\
%
\frac{\partial N_i}{\partial \xi_1}y_i^e  & \frac{\partial N_i}{\partial \xi_2}y_i^e &\frac{\partial N_i}{\partial \xi_3}y_1^e  \\
%
\frac{\partial N_b}{\partial \xi_1}  & \frac{\partial N_b}{\partial \xi_2} & \frac{\partial N_b}{\partial \xi_3} 
\end{bmatrix}\right) 
%
= W_1\sum_{e=1}^{N_{el}} \text{det}\left(
%
\begin{bmatrix}
\frac{\partial N_a}{\partial \xi_1}  &  \frac{\partial N_a}{\partial \xi_2} &  \frac{\partial N_a}{\partial \xi_3}\\
%
y_2^e - y_1^e & y_3^e - y_1^e & y_4^e - y_1^e \\
%
\frac{\partial N_b}{\partial \xi_1}  & \frac{\partial N_b}{\partial \xi_2} & \frac{\partial N_b}{\partial \xi_3} 
\end{bmatrix}\right) \nonumber\\
%%%
&=& W_1\sum_{e=1}^{N_{el}}\frac{\partial N_a}{\partial \xi_1}\left[(y_3^e - y_1^e)\frac{\partial N_b}{\partial \xi_3}-(y_4^e - y_1^e)\frac{\partial N_b}{\partial \xi_2}\right] 
%
-\frac{\partial N_a}{\partial \xi_2}\left[(y_2^e - y_1^e)\frac{\partial N_b}{\partial \xi_3}-(y_4^e - y_1^e)\frac{\partial N_b}{\partial \xi_1}\right] \nonumber\\
%
&&+\frac{\partial N_a}{\partial \xi_3}\left[(y_2^e - y_1^e)\frac{\partial N_b}{\partial \xi_2}-(y_3^e - y_1^e)\frac{\partial N_b}{\partial \xi_1}\right] 
\end{eqnarray}
%%%%%
%%%%%
%%%%%
\begin{eqnarray}
\frac{\partial^2 V}{\partial y_a^e \partial z_b^e} &=& W_1\sum_{e=1}^{N_{el}} \text{det}\left(\sum_{i=1}^{n_{en}} \begin{bmatrix}
\frac{\partial N_i}{\partial \xi_1}x_i^e  & \frac{\partial N_i}{\partial \xi_2}x_i^e & \frac{\partial N_i}{\partial \xi_3}x_i^e \\
%
\frac{\partial N_a}{\partial \xi_1} & \frac{\partial N_a}{\partial \xi_2} & \frac{\partial N_a}{\partial \xi_3}  \\
%
 \frac{\partial N_b}{\partial \xi_1}  & \frac{\partial N_b}{\partial \xi_2} & \frac{\partial N_b}{\partial \xi_3}
\end{bmatrix}\right) 
%
= W_1\sum_{e=1}^{N_{el}} \text{det}\left(\begin{bmatrix}
x_2^e - x_1^e & x_3^e - x_1^e & x_4^e - x_1^e \\
%
\frac{\partial N_a}{\partial \xi_1} & \frac{\partial N_a}{\partial \xi_2} & \frac{\partial N_a}{\partial \xi_3}  \\
%
 \frac{\partial N_b}{\partial \xi_1}  & \frac{\partial N_b}{\partial \xi_2} & \frac{\partial N_b}{\partial \xi_3}
\end{bmatrix}\right) \nonumber\\
%%%
&=&W_1\sum_{e=1}^{N_{el}}(x_2^e - x_1^e)\left[\frac{\partial N_a}{\partial \xi_2}\frac{\partial N_b}{\partial \xi_3}-\frac{\partial N_a}{\partial \xi_3}\frac{\partial N_b}{\partial \xi_2}\right] 
%
-(x_3^e - x_1^e)\left[\frac{\partial N_a}{\partial \xi_1}\frac{\partial N_b}{\partial \xi_3}-\frac{\partial N_a}{\partial \xi_3}\frac{\partial N_b}{\partial \xi_1}\right] \nonumber\\
%
&&+(x_4^e - x_1^e)\left[\frac{\partial N_a}{\partial \xi_1}\frac{\partial N_b}{\partial \xi_2}-\frac{\partial N_a}{\partial \xi_2}\frac{\partial N_b}{\partial \xi_1}\right],
\label{eq:dV-offdiag}
\end{eqnarray}
%
where 
%
\begin{equation}
\frac{\partial^2 V}{\partial y_a^e \partial x_b^e} = \frac{\partial^2 V}{\partial x_a^e \partial y_b^e}, \ \
%
\frac{\partial^2 V}{\partial z_a^e \partial x_b^e} = \frac{\partial^2 V}{\partial x_a^e \partial z_b^e}, \ \
%
\frac{\partial^2 V}{\partial z_a^e \partial y_b^e} = \frac{\partial^2 V}{\partial y_a^e \partial z_b^e}
\end{equation}

\section{Volume Calculations Based on Surface Mesh}

According to Hong et al.\ \cite{Hong:2006vz}, the total volume of an object can be determined from its surface mesh by
%
\begin{eqnarray}
&&V = \frac{1}{3}\sum_{s=1}^{N_s} V^{(s)}, \text{ where } \nonumber\\
&&V^{(s)} =  \frac{A^{(s)}}{3}\left[ N^{(s)}_x (x^{(s)}_1 + x^{(s)}_2 + x^{(s)}_3) + N^{(s)}_y (y^{(s)}_1 + y^{(s)}_2 + y^{(s)}_3) + N^{(s)}_z (z^{(s)}_1 + z^{(s)}_2 + z^{(s)}_3) \right]. \nonumber\\
\label{eq:volume_from_surf}
\end{eqnarray}
% 
In Eq.\ \eqref{eq:volume_from_surf} the superscript $s$ indicates values corresponding to the $s^{th}$ triangle on the surface mesh, $N_s$ is the total number of triangles on the surface mesh, and $V^{(s)}$ is the contribution of the $s^{th}$ triangle on the surface mesh to the total volume. The variables $x_i, y_i$, and $z_i$ are the $x, y$, and $z$ coordinates of the $i^{th}$ node of a single triangle on the surface mesh and $N_i$ corresponds to the $i^{th}$ component of the normal to a triangle on the surface mesh. Note that all coordinates are in terms of the physical domain and not the parent domain.

\subsection{First Derivative of Volume}
The change of total volume from the change of a single nodal displacement $\pmb{u}_a$ at a node $a$ (=1 to 3 for linear surface triangle element) of a triangular surface element $s$ is
%
\begin{eqnarray}
\frac{\partial V}{\partial \pmb{u}_a^{(s)}} &=& \frac{\partial V}{\partial (\pmb{x}_a^{(s)}-\pmb{X}_a^{(s)})} = \frac{\partial V}{\partial \pmb{x}_a^{(se)}} \nonumber\\
%%
&=& \frac{\partial}{\partial \pmb{x}_a^{(s)}} \frac{1}{3} \sum_{s=1}^{N_s}V^{(s)} = \frac{1}{3} \sum_{s=1}^{N_s}\frac{\partial V^{(s)}}{\partial \pmb{x}_a^{(s)}}
%%
= \frac{1}{3} \begin{bmatrix}
\frac{\partial V}{\partial x_a^{(s)}} \\ \frac{\partial V}{\partial y_a^{(s)}} \\ \frac{\partial V}{\partial z_a^{(s)}}
\end{bmatrix}, \text { for } a = 1 \text{ to } 3.
\label{eq:dVdu_surface}
\end{eqnarray}
%
Note that in Eq.\ \eqref{eq:dVdu_surface} each $\partial V^{(s)}/\partial \pmb{x}_a^{(s)}$ term is calculated in the atPoint function of the constraint integrator. The summation is performed by accumulating into the tangent-stiffness matrix and residual vector via the amsi::assembleMatrix and amsi::assembleVector functions, respectively.

According to Hong et al.\ \cite{Hong:2006vz}, the $\partial V^{(s)}/\partial \pmb{x}_a^{(s)}$ term can be determined from the nodal coordinates of the triangle of the surface mesh explicitly as
%
\begin{eqnarray}
\frac{\partial V^{(s)}}{\partial x^{(s)}_1} = \frac{1}{2} \left(y^{(s)}_3 z^{(s)}_2 - y^{(s)}_2 z^{(s)}_3 \right) \ \
\frac{\partial V^{(s)}}{\partial y^{(s)}_1} = \frac{1}{2} \left(-x^{(s)}_3 z^{(s)}_2 + x^{(s)}_2 z^{(s)}_3 \right) \ \
\frac{\partial V^{(s)}}{\partial z^{(s)}_1} = \frac{1}{2} \left(x^{(s)}_3 y^{(s)}_2 - x^{(s)}_2 y^{(s)}_3 \right) \nonumber\\
%%%
\frac{\partial V^{(s)}}{\partial x^{(s)}_2} = \frac{1}{2} \left(-y^{(s)}_3 z^{(s)}_1 + y^{(s)}_1 z^{(s)}_3 \right) \ \
\frac{\partial V^{(s)}}{\partial y^{(s)}_2} = \frac{1}{2} \left(x^{(s)}_3 z^{(s)}_1 - x^{(s)}_1 z^{(s)}_3 \right) \ \
\frac{\partial V^{(s)}}{\partial z^{(s)}_2} = \frac{1}{2} \left(-x^{(s)}_3 y^{(s)}_1 + x^{(s)}_1 y^{(s)}_3 \right) \nonumber\\
%%%
\frac{\partial V^{(s)}}{\partial x^{(s)}_3} = \frac{1}{2} \left(y^{(s)}_2 z^{(s)}_1 - y^{(s)}_1 z^{(s)}_2 \right) \ \
\frac{\partial V^{(s)}}{\partial y^{(s)}_3} = \frac{1}{2} \left(-x^{(s)}_2 z^{(s)}_1 + x^{(s)}_1 z^{(s)}_2 \right) \ \
\frac{\partial V^{(s)}}{\partial z^{(s)}_3} = \frac{1}{2} \left(x^{(s)}_2 y^{(s)}_1 - x^{(s)}_1 y^{(s)}_2 \right). \nonumber\\
\label{eq:dVdu_explicit}
\end{eqnarray}
%

\subsection{Second Derivative of Volume}

The second derivative of the total volume is determined by observing the change of Eq.\ \eqref{eq:dVdu_surface} due to the change of a single nodal displacement $\pmb{u}_b$ at a node of $b$ (=1 to 3 for linear triangle element) of surface element $s$
%
\begin{eqnarray}
\frac{\partial}{\partial \pmb{u}_b^{(s)}}\frac{\partial V}{\partial \pmb{u}_a^{(s)}} &=& \frac{\partial}{\partial \pmb{x}_b^{(s)}}\frac{\partial V}{\partial \pmb{x}_a^{(s)}} 
%
=\sum_{s=1}^{N_{s}}\frac{\partial^2 V^{(s)}}{\partial \pmb{x}_a^{(s)} \partial \pmb{x}_b^{(s)}} = 
%
\frac{1}{3}\begin{bmatrix}
\frac{\partial^2 V}{\partial x_a^{(s)} \partial x_b^{(s)}} & \frac{\partial^2 V}{\partial x_a^{(s)} \partial y_b^{(s)}} & \frac{\partial^2 V}{\partial x_a^{(s)} \partial z_b^{(s)}} \\
%
\frac{\partial^2 V}{\partial y_a^{(s)} \partial x_b^{(s)}} & \frac{\partial^2 V}{\partial y_a^{(s)} \partial y_b^{(s)}} & \frac{\partial^2 V}{\partial y_a^{(s)} \partial z_b^{(s)}} \\
%
\frac{\partial^2 V}{\partial z_a^{(s)} \partial x_b^{(s)}} & \frac{\partial^2 V}{\partial z_a^{(s)} \partial y_b^{(s)}} & \frac{\partial^2 V}{\partial z_a^{(s)} \partial z_b^{(s)}} 
\end{bmatrix}, \text{ for } a,b = 1 \text{ to } 3. \nonumber\\
\label{eq:dVduadub_surface}
\end{eqnarray}
%
Similar to Eq.\ \eqref{eq:dVdu_surface}, the $\partial ^2 V^{(s)}/\partial x_a^{(s)}\partial x_b^{(s)}$ term in Eq.\ \eqref{eq:dVduadub_surface} is calculated within the atPoint function of the constraint integrator. Analogously, the summation is performed by accumulating into the tangent-stiffness matrix and residual vector via the amsi::assembleMatrix and amsi::assembleVector functions, respectively.

The terms $\partial ^2 V^{(s)}/\partial x_a^{(s)}\partial x_b^{(s)}$ in Eq.\ \eqref{eq:dVduadub_surface} can also be written out explicitly by taking derivatives of the terms in Eq.\ \eqref{eq:dVdu_explicit}. 

The $x-x$ terms are 
%
\begin{eqnarray}
\frac{\partial^2V^{(s)}}{\partial x_a^{(s)} \partial x_b^{(s)}} = 
\begin{bmatrix}
\frac{\partial^2V^{(s)}}{\partial x_1^{(s)} \partial x_1^{(s)}} & \frac{\partial^2V^{(s)}}{\partial x_1^{(s)} \partial x_2^{(s)}}  & \frac{\partial^2V^{(s)}}{\partial x_1^{(s)} \partial x_3^{(s)}} \\
%
\frac{\partial^2V^{(s)}}{\partial x_2^{(s)} \partial x_1^{(s)}} & \frac{\partial^2V^{(s)}}{\partial x_2^{(s)} \partial x_2^{(s)}}  & \frac{\partial^2V^{(s)}}{\partial x_2^{(s)} \partial x_3^{(s)}} \\
%
\frac{\partial^2V^{(s)}}{\partial x_3^{(s)} \partial x_1^{(s)}} & \frac{\partial^2V^{(s)}}{\partial x_3^{(s)} \partial x_2^{(s)}}  & \frac{\partial^2V^{(s)}}{\partial x_3^{(s)} \partial x_3^{(s)}}
\end{bmatrix} =
%%%
\begin{bmatrix}
0 & 0 & 0 \\
0 & 0 & 0 \\
0 & 0 & 0
\end{bmatrix}.
\end{eqnarray}
%

The $y-y$ terms are
%
\begin{eqnarray}
\frac{\partial^2V^{(s)}}{\partial y_a^{(s)} \partial y_b^{(s)}} = 
\begin{bmatrix}
\frac{\partial^2V^{(s)}}{\partial y_1^{(s)} \partial y_1^{(s)}} & \frac{\partial^2V^{(s)}}{\partial y_1^{(s)} \partial y_2^{(s)}}  & \frac{\partial^2V^{(s)}}{\partial y_1^{(s)} \partial y_3^{(s)}} \\
%
\frac{\partial^2V^{(s)}}{\partial y_2^{(s)} \partial y_1^{(s)}} & \frac{\partial^2V^{(s)}}{\partial y_2^{(s)} \partial y_2^{(s)}}  & \frac{\partial^2V^{(s)}}{\partial y_2^{(s)} \partial y_3^{(s)}} \\
%
\frac{\partial^2V^{(s)}}{\partial y_3^{(s)} \partial y_1^{(s)}} & \frac{\partial^2V^{(s)}}{\partial y_3^{(s)} \partial y_2^{(s)}}  & \frac{\partial^2V^{(s)}}{\partial y_3^{(s)} \partial y_3^{(s)}}
\end{bmatrix} =
%%%
\begin{bmatrix}
0 & 0 & 0 \\
0 & 0 & 0 \\
0 & 0 & 0
\end{bmatrix}.
\end{eqnarray}
%

The $z-z$ terms are
%
\begin{eqnarray}
\frac{\partial^2V^{(s)}}{\partial z_a^{(s)} \partial z_b^{(s)}} = 
\begin{bmatrix}
\frac{\partial^2V^{(s)}}{\partial z_1^{(s)} \partial z_1^{(s)}} & \frac{\partial^2V^{(s)}}{\partial z_1^{(s)} \partial z_2^{(s)}}  & \frac{\partial^2V^{(s)}}{\partial z_1^{(s)} \partial z_3^{(s)}} \\
%
\frac{\partial^2V^{(s)}}{\partial z_2^{(s)} \partial z_1^{(s)}} & \frac{\partial^2V^{(s)}}{\partial z_2^{(s)} \partial z_2^{(s)}}  & \frac{\partial^2V^{(s)}}{\partial z_2^{(s)} \partial z_3^{(s)}} \\
%
\frac{\partial^2V^{(s)}}{\partial z_3^{(s)} \partial z_1^{(s)}} & \frac{\partial^2V^{(s)}}{\partial z_3^{(s)} \partial z_2^{(s)}}  & \frac{\partial^2V^{(s)}}{\partial z_3^{(s)} \partial z_3^{(s)}}
\end{bmatrix} =
%%%
\begin{bmatrix}
0 & 0 & 0 \\
0 & 0 & 0 \\
0 & 0 & 0
\end{bmatrix}.
\end{eqnarray}
%

The $x-y$ terms are
%
\begin{eqnarray}
\frac{\partial^2V^{(s)}}{\partial x_a^{(s)} \partial y_b^{(s)}} = \frac{\partial^2V^{(s)}}{\partial y_a^{(s)} \partial x_b^{(s)}}=
\begin{bmatrix}
\frac{\partial^2V^{(s)}}{\partial x_1^{(s)} \partial y_1^{(s)}} & \frac{\partial^2V^{(s)}}{\partial x_1^{(s)} \partial y_2^{(s)}}  & \frac{\partial^2V^{(s)}}{\partial x_1^{(s)} \partial y_3^{(s)}} \\
%
\frac{\partial^2V^{(s)}}{\partial x_2^{(s)} \partial y_1^{(s)}} & \frac{\partial^2V^{(s)}}{\partial x_2^{(s)} \partial y_2^{(s)}}  & \frac{\partial^2V^{(s)}}{\partial x_2^{(s)} \partial y_3^{(s)}} \\
%
\frac{\partial^2V^{(s)}}{\partial x_3^{(s)} \partial y_1^{(s)}} & \frac{\partial^2V^{(s)}}{\partial x_3^{(s)} \partial y_2^{(s)}}  & \frac{\partial^2V^{(s)}}{\partial x_3^{(s)} \partial y_3^{(s)}}
\end{bmatrix} =
%%%
\frac{1}{2}
\begin{bmatrix}
0 & -z_3^{(s)} & z_2^{(s)} \\
z_3^{(s)} & 0 & -z_1^{(s)} \\
-z_2^{(s)} & z_1^{(s)} & 0
\end{bmatrix}.
\end{eqnarray}
%

The $x-z$ terms are
%
\begin{eqnarray}
\frac{\partial^2V^{(s)}}{\partial x_a^{(s)} \partial z_b^{(s)}} = \frac{\partial^2V^{(s)}}{\partial z_a^{(s)} \partial x_b^{(s)}} = 
\begin{bmatrix}
\frac{\partial^2V^{(s)}}{\partial x_1^{(s)} \partial z_1^{(s)}} & \frac{\partial^2V^{(s)}}{\partial x_1^{(s)} \partial z_2^{(s)}}  & \frac{\partial^2V^{(s)}}{\partial x_1^{(s)} \partial z_3^{(s)}} \\
%
\frac{\partial^2V^{(s)}}{\partial x_2^{(s)} \partial z_1^{(s)}} & \frac{\partial^2V^{(s)}}{\partial x_2^{(s)} \partial z_2^{(s)}}  & \frac{\partial^2V^{(s)}}{\partial x_2^{(s)} \partial z_3^{(s)}} \\
%
\frac{\partial^2V^{(s)}}{\partial x_3^{(s)} \partial z_1^{(s)}} & \frac{\partial^2V^{(s)}}{\partial x_3^{(s)} \partial z_2^{(s)}}  & \frac{\partial^2V^{(s)}}{\partial x_3^{(s)} \partial z_3^{(s)}}
\end{bmatrix} =
%%%
\frac{1}{2}
\begin{bmatrix}
0 & y_3^{(s)} & -y_2^{(s)} \\
-y_3^{(s)} & 0 & y_1^{(s)} \\
y_2^{(s)} & -y_1^{(s)} & 0
\end{bmatrix}.
\end{eqnarray}
%

The $y-z$ terms are
%
\begin{eqnarray}
\frac{\partial^2V^{(s)}}{\partial y_a^{(s)} \partial z_b^{(s)}} = \frac{\partial^2V^{(s)}}{\partial z_a^{(s)} \partial y_b^{(s)}} = 
\begin{bmatrix}
\frac{\partial^2V^{(s)}}{\partial y_1^{(s)} \partial z_1^{(s)}} & \frac{\partial^2V^{(s)}}{\partial y_1^{(s)} \partial z_2^{(s)}}  & \frac{\partial^2V^{(s)}}{\partial y_1^{(s)} \partial z_3^{(s)}} \\
%
\frac{\partial^2V^{(s)}}{\partial y_2^{(s)} \partial z_1^{(s)}} & \frac{\partial^2V^{(s)}}{\partial y_2^{(s)} \partial z_2^{(s)}}  & \frac{\partial^2V^{(s)}}{\partial y_2^{(s)} \partial z_3^{(s)}} \\
%
\frac{\partial^2V^{(s)}}{\partial y_3^{(s)} \partial z_1^{(s)}} & \frac{\partial^2V^{(s)}}{\partial y_3^{(s)} \partial z_2^{(s)}}  & \frac{\partial^2V^{(s)}}{\partial y_3^{(s)} \partial z_3^{(s)}}
\end{bmatrix} =
%%%
\begin{bmatrix}
0 & -x_3^{(s)} & x_2^{(s)} \\
x_3^{(s)} & 0 & -x_1^{(s)} \\
-x_2^{(s)} & x_1^{(s)} & 0
\end{bmatrix}.
\end{eqnarray}
%


\bibliographystyle{apsrev}
\bibliography{References}
\end{document}